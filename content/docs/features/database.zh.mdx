---
title: 数据库
description: 学习如何在 AIGXT 中使用 Drizzle ORM 处理数据库
icon: "Database"
---

# 数据库

AIGXT 使用 Drizzle ORM 和 PostgreSQL 进行强大的数据库管理。本指南涵盖数据库设置、架构设计和最佳实践。

## 数据库设置

### PostgreSQL 配置

AIGXT 使用 PostgreSQL 作为主数据库。配置您的连接：

```env
DATABASE_URL="postgresql://username:password@localhost:5432/aigxt"
```

### Drizzle ORM 设置

数据库架构在 `src/db/schema.ts` 中定义：

```typescript
import { pgTable, serial, varchar, timestamp, text, boolean } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  name: varchar('name', { length: 255 }),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  title: varchar('title', { length: 255 }).notNull(),
  content: text('content'),
  published: boolean('published').default(false),
  authorId: serial('author_id').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});
```

## 数据库操作

### 连接设置

```typescript
// src/db/index.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

const connectionString = process.env.DATABASE_URL!;
const client = postgres(connectionString);
export const db = drizzle(client, { schema });
```

### 基本 CRUD 操作

#### 创建记录

```typescript
import { db } from '@/db';
import { users, posts } from '@/db/schema';

// 创建用户
const newUser = await db.insert(users).values({
  email: 'user@example.com',
  name: 'John Doe',
}).returning();

// 创建文章
const newPost = await db.insert(posts).values({
  title: '我的第一篇文章',
  content: '这是我第一篇文章的内容。',
  authorId: newUser[0].id,
  published: true,
}).returning();
```

#### 读取记录

```typescript
import { eq, and, or, like } from 'drizzle-orm';

// 获取所有用户
const allUsers = await db.select().from(users);

// 通过邮箱获取用户
const user = await db.select().from(users).where(eq(users.email, 'user@example.com'));

// 获取已发布的文章
const publishedPosts = await db.select().from(posts).where(eq(posts.published, true));

// 通过标题搜索文章
const searchResults = await db.select().from(posts).where(
  like(posts.title, '%搜索词%')
);
```

#### 更新记录

```typescript
// 更新用户
await db.update(users)
  .set({ name: 'Jane Doe' })
  .where(eq(users.id, 1));

// 更新文章
await db.update(posts)
  .set({ 
    title: '更新的标题',
    updatedAt: new Date()
  })
  .where(eq(posts.id, 1));
```

#### 删除记录

```typescript
// 删除用户
await db.delete(users).where(eq(users.id, 1));

// 删除文章
await db.delete(posts).where(eq(posts.id, 1));
```

## 关系和连接

### 定义关系

```typescript
// src/db/schema.ts
import { relations } from 'drizzle-orm';

export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
  }),
}));
```

### 使用关系查询

```typescript
import { db } from '@/db';
import { users, posts } from '@/db/schema';

// 获取用户及其文章
const userWithPosts = await db.query.users.findFirst({
  where: eq(users.id, 1),
  with: {
    posts: true,
  },
});

// 获取文章及其作者
const postWithAuthor = await db.query.posts.findFirst({
  where: eq(posts.id, 1),
  with: {
    author: true,
  },
});

// 获取所有文章及其作者
const allPostsWithAuthors = await db.query.posts.findMany({
  with: {
    author: true,
  },
});
```

## 迁移

### 生成迁移

当您修改架构时，生成迁移文件：

```bash
pnpm db:generate
```

这会在 `src/db/migrations/` 中创建迁移文件。

### 应用迁移

将待处理的迁移应用到数据库：

```bash
pnpm db:migrate
```

### 开发模式

在开发中，您可以直接推送架构更改：

```bash
pnpm db:push
```

**注意**：仅在开发中使用 `db:push`。在生产中始终使用迁移。

## 高级查询

### 复杂条件查询

```typescript
import { and, or, not, inArray, between } from 'drizzle-orm';

// 多个条件
const complexQuery = await db.select().from(posts).where(
  and(
    eq(posts.published, true),
    or(
      like(posts.title, '%AI%'),
      like(posts.content, '%机器学习%')
    ),
    not(eq(posts.authorId, 1))
  )
);

// IN 子句
const specificPosts = await db.select().from(posts).where(
  inArray(posts.id, [1, 2, 3, 4, 5])
);

// BETWEEN 子句
const recentPosts = await db.select().from(posts).where(
  between(posts.createdAt, new Date('2024-01-01'), new Date('2024-12-31'))
);
```

### 聚合函数

```typescript
import { count, sum, avg, max, min } from 'drizzle-orm';

// 按用户统计文章数量
const postCounts = await db
  .select({
    userId: posts.authorId,
    postCount: count(),
  })
  .from(posts)
  .groupBy(posts.authorId);

// 获取统计信息
const stats = await db
  .select({
    totalPosts: count(),
    publishedPosts: count(posts.published),
  })
  .from(posts);
```

### 分页

```typescript
import { desc, asc, limit, offset } from 'drizzle-orm';

// 分页文章
const page = 1;
const pageSize = 10;
const offsetValue = (page - 1) * pageSize;

const paginatedPosts = await db
  .select()
  .from(posts)
  .orderBy(desc(posts.createdAt))
  .limit(pageSize)
  .offset(offsetValue);
```

## 事务

### 基本事务

```typescript
import { db } from '@/db';

await db.transaction(async (tx) => {
  // 创建用户
  const newUser = await tx.insert(users).values({
    email: 'user@example.com',
    name: 'John Doe',
  }).returning();

  // 为用户创建文章
  await tx.insert(posts).values({
    title: '欢迎文章',
    content: '欢迎来到我们的平台！',
    authorId: newUser[0].id,
    published: true,
  });
});
```

### 事务中的错误处理

```typescript
try {
  await db.transaction(async (tx) => {
    // 数据库操作
    const user = await tx.insert(users).values(userData).returning();
    await tx.insert(posts).values({
      ...postData,
      authorId: user[0].id,
    });
  });
} catch (error) {
  console.error('事务失败:', error);
  // 适当处理错误
}
```

## 数据库索引

### 创建索引

```typescript
// src/db/schema.ts
import { index } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  name: varchar('name', { length: 255 }),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
  emailIdx: index('email_idx').on(table.email),
  createdAtIdx: index('created_at_idx').on(table.createdAt),
}));

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  title: varchar('title', { length: 255 }).notNull(),
  content: text('content'),
  published: boolean('published').default(false),
  authorId: serial('author_id').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
  authorIdIdx: index('author_id_idx').on(table.authorId),
  publishedIdx: index('published_idx').on(table.published),
  titleIdx: index('title_idx').on(table.title),
}));
```

## 数据库工作室

### 使用 Drizzle Studio

Drizzle Studio 提供数据库管理的 Web 界面：

```bash
pnpm db:studio
```

这会在 `http://localhost:4983` 打开一个 Web 界面，您可以：

- 查看和编辑数据
- 运行查询
- 管理表
- 导出数据

## 性能优化

### 连接池

```typescript
// src/db/index.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

const connectionString = process.env.DATABASE_URL!;

// 配置连接池
const client = postgres(connectionString, {
  max: 20, // 最大连接数
  idle_timeout: 20, // 20 秒后关闭空闲连接
  connect_timeout: 10, // 连接超时
});

export const db = drizzle(client, { schema });
```

### 查询优化

```typescript
// 使用 select 限制列
const userEmails = await db.select({ email: users.email }).from(users);

// 对重复查询使用预准备语句
const getUserById = db.select().from(users).where(eq(users.id, placeholder('id'))).prepare();

const user1 = await getUserById.execute({ id: 1 });
const user2 = await getUserById.execute({ id: 2 });
```

## 安全最佳实践

### SQL 注入防护

Drizzle ORM 通过参数化查询自动防止 SQL 注入：

```typescript
// 安全 - Drizzle 处理参数化
const user = await db.select().from(users).where(eq(users.email, userEmail));

// 永远不要这样做 - 直接字符串连接
// const user = await db.execute(`SELECT * FROM users WHERE email = '${userEmail}'`);
```

### 输入验证

```typescript
import { z } from 'zod';

const userSchema = z.object({
  email: z.string().email(),
  name: z.string().min(1).max(255),
});

export async function createUser(userData: unknown) {
  const validatedData = userSchema.parse(userData);
  
  return await db.insert(users).values(validatedData).returning();
}
```

## 错误处理

### 数据库错误处理

```typescript
import { PostgresError } from 'postgres';

export async function createUser(userData: any) {
  try {
    return await db.insert(users).values(userData).returning();
  } catch (error) {
    if (error instanceof PostgresError) {
      switch (error.code) {
        case '23505': // 唯一性违反
          throw new Error('使用此邮箱的用户已存在');
        case '23503': // 外键违反
          throw new Error('引用的记录不存在');
        default:
          throw new Error('发生数据库错误');
      }
    }
    throw error;
  }
}
```

## 监控和日志

### 查询日志

```typescript
// src/db/index.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

const client = postgres(connectionString, {
  debug: process.env.NODE_ENV === 'development',
  onnotice: (notice) => {
    console.log('数据库通知:', notice);
  },
});

export const db = drizzle(client, { 
  schema,
  logger: process.env.NODE_ENV === 'development',
});
```

### 性能监控

```typescript
export async function executeWithTiming<T>(
  operation: () => Promise<T>,
  operationName: string
): Promise<T> {
  const start = Date.now();
  try {
    const result = await operation();
    const duration = Date.now() - start;
    console.log(`${operationName} 在 ${duration}ms 内完成`);
    return result;
  } catch (error) {
    const duration = Date.now() - start;
    console.error(`${operationName} 在 ${duration}ms 后失败:`, error);
    throw error;
  }
}
```

## 最佳实践

1. **架构设计**：设计具有适当关系的规范化架构
2. **索引**：为频繁查询的列添加索引
3. **迁移**：始终使用迁移进行架构更改
4. **事务**：对相关操作使用事务
5. **错误处理**：实施全面的错误处理
6. **验证**：在数据库操作之前验证数据
7. **性能**：监控和优化慢查询
8. **安全**：使用参数化查询和验证输入
9. **备份**：实施定期数据库备份
10. **监控**：监控数据库性能和错误

## 故障排除

### 常见问题

**连接问题：**
- 验证 `DATABASE_URL` 是否正确
- 检查 PostgreSQL 是否正在运行
- 验证网络连接

**迁移问题：**
- 检查迁移文件的语法错误
- 确保数据库可访问
- 验证架构更改是否有效

**性能问题：**
- 添加适当的索引
- 优化查询
- 监控连接池使用情况

如需更多帮助，请查看[故障排除指南](/docs/troubleshooting)或访问我们的[支持页面](/support)。
